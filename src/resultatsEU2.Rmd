---
title: "Résumé des résultats EU : indicateurs de comptabilité carbone"
author: "Léa Settepani"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(data.table)
library(readxl)
library(openxlsx)
library(stringr)
library(ggpubr)
library(scales)
```

## Description des données utilisées


```{r nomenclatures et header, echo=FALSE}
year <- 2015
br <- "CPA2002_Niv1"
br_pays <- "EU1"

#Chemin user, du projet, et données résultats
path_user <- str_c("C:/Users/leasy/")
path_codedata <- str_c(path_user,"Documents/GitHub/EmissionsIndicators/")

path_results_tables <- str_c(path_codedata, "results/IO_pays/", year,"/",br_pays,"_",br,"/")

table_EU <- readRDS(str_c(path_results_tables, "IO_all_",br_pays,"_",br,".rds"))
```

## Visualisation et analyse des résultats

```{r results, include=FALSE}
for (pays in c("Autriche","Belgique","Bulgarie","Chypre","République Tchèque","Allemagne",
               "Danemark","Estonie","Espagne","Finlande","France","Grèce","Croatie","Hongrie",
               "Irlande","Italie","Lituanie","Luxembourg","Lettonnie","Malte","Pays-bas",
               "Pologne","Portugal","Roumanie","Suède","Slovénie","Slovaquie","Royaume-Uni",
               "Reste du monde")) {

  IO <- readRDS(str_c(path_results_tables,"IO_",pays,".rds"))
  assign(str_c("IO_",pays),IO)
  rm(IO)
}

#Créer grand dataframe (monde)
IO_all <- do.call("rbind",mget(ls(pattern = "^IO_*")))

#Plot monde secteurs
EU_secteurs <- IO_all %>% 
  group_by(produits) %>%
  filter(produits != "SERVICES EXTRA-TERRITORIAUX") %>%
  mutate(agg.demande_impact=sum(GES_impact_M_select),
         agg.producteur_impact=sum(GES_impact_S_select),
         agg.VA_impact=sum(impact_VA_select),
         agg.production=sum(production_pays),
         agg.demande_finale=sum(DF_tot)) %>%
  ungroup() %>% 
  pivot_longer(
    cols = c("agg.producteur_impact","agg.demande_impact","agg.VA_impact"),
    names_to = "indicator",
    values_to = "impact") %>%
  as.data.frame() %>% 
  ggplot( 
    aes(x= produits, 
        y = impact,
        fill = indicator)) +
  geom_bar(stat='identity',position = "dodge") +
  theme(axis.text.x = element_text(angle = 25, size=4, vjust = 1, hjust=1),
        plot.title =element_text(size=12, face='bold', hjust=0.5),
        panel.background = element_blank(),
        panel.grid.major.y=element_line(color="gray",size=0.5,linetype = 2),
        plot.margin = unit(c(10,5,5,5), "mm"))+
  labs(title="Impacts",
       x ="Secteurs", y = "Impact GES (CO2eq)",
       fill="Indicateur") +
  scale_fill_manual(labels = c("Demande", "Production","VA"), values = c("indianred1", "cornflowerblue","orange1"))

#Plot européen par pays
EU_pays <- IO_all %>% 
  filter(nom_pays != "Reste du monde") %>%
  group_by(nom_pays) %>%
  mutate(agg.demande_impact=sum(GES_impact_M_select),
         agg.producteur_impact=sum(GES_impact_S_select),
         agg.VA_impact=sum(impact_VA_select),
         agg.production=sum(production_pays),
         agg.demande_finale=sum(DF_tot)) %>%
  ungroup() %>%
  mutate(categorie.produit=substr(produits, 1,5)) %>% 
  pivot_longer(
    cols = c("agg.producteur_impact","agg.demande_impact","agg.VA_impact"),
    names_to = "indicator",
    values_to = "impact") %>%
  as.data.frame() %>% 
  ggplot( 
    aes(x= nom_pays, 
        y = impact,
        fill = indicator)) +
  geom_bar(stat='identity',position = "dodge") +
  theme(axis.text.x = element_text(angle = 25, size=6, vjust = 1, hjust=1),
        plot.title =element_text(size=12, face='bold', hjust=0.5),
        panel.background = element_blank(),
        panel.grid.major.y=element_line(color="gray",size=0.5,linetype = 2),
        plot.margin = unit(c(10,5,5,5), "mm"))+
  labs(title="Impacts",
       x ="Région ou pays", y = "Impact GES (CO2eq)",
       fill="Indicateur") +
  scale_fill_manual(labels = c("Demande", "Production","VA"), values = c("indianred1", "cornflowerblue","orange1"))

#Plot européen par secteur pour VA
EU_secteurs_VA=IO_all %>% 
  filter(nom_pays != "Reste du monde") %>%
  #par produits
  group_by(produits) %>%
  filter(produits != "SERVICES EXTRA-TERRITORIAUX") %>% #toujours=0
  mutate(agg.Etat=sum(Etat),
         agg.Travail=sum(Travail),
         agg.Capital=sum(Capital),
         agg.Cout=sum(Cout_production)) %>%
  ungroup() %>%
  #format long pour afficher les deux indicateurs
  pivot_longer(
    cols = c("agg.Etat","agg.Travail","agg.Capital","agg.Cout"),
    names_to = "composante",
    values_to = "impact") %>%
  ggplot( 
    aes(x= produits, 
        y = impact,
        fill = composante)) +
  geom_bar(stat='identity',
           position = position_stack(reverse = FALSE)) + #fill
  theme(axis.text.x = element_text(angle = 25, size=4, vjust = 1, hjust=1),
        plot.title =element_text(size=12, face='bold', hjust=0.5),
        panel.background = element_blank(),
        panel.grid.major.y=element_line(color="gray",size=0.5,linetype = 2),
        plot.margin = unit(c(10,5,5,5), "mm"))+
  labs(title="Impacts",
       x ="Secteurs", y = "Impact GES (CO2eq)",
       fill="Indicateur") +
  scale_fill_manual(labels = c("E", "L","K","CP"), values = c("gray95", "gray85","gray75","gray65"))
```



### Faits stylisés au niveau mondial

Les trois graphiques au niveau mondial sont inclus pour avoir une vision plus globale.

```{r monde pays, echo=FALSE}
EU_pays
```

Dans l'Union Européenne, la plupart des pays sont nets demandeurs d'émissions. L'Union dans son ensemble est également nette demandeuse d'émissions (le reste du monde produit plus d'émissions qu'il n'en demande). Certains pays européens sont nets producteurs (la Bulgarie, Chypre, l'Estonie, la Grèce, la Pologne, le Portugal, la République Tchèque) mais la différence n'est flagrante que pour quatre d'entre eux.

L'Allemagne a de loin le plus fort impact selon les trois approches.

```{r monde secteurs, echo=FALSE}
EU_secteurs
```


```{r monde secteurs va, echo=FALSE, dev = "png", dpi=400}
EU_secteurs_VA
```

Globalement, parmi les facteurs de production c'est le capital fixe qui a le plus fort impact.

### Contrastes par pays

```{r groupes pays eu, echo=FALSE}
##groupes de pays (EuroVoc)
eastern <- c("Bulgarie","République Tchèque","Hongrie",
             "Roumanie","Pologne","Slovaquie","Slovénie","Croatie")
western <- c("Autriche","Belgique","Allemagne","France","Pays-bas",
             "Luxembourg","Royaume-Uni")
southern <- c("Chypre","Espagne","Grèce","Italie",
              "Portugal","Malte")
northern <- c("Danemark","Estonie","Lituanie","Lettonnie","Finlande","Irlande",
              "Suède")

IO_all2 <- IO_all %>%
  mutate(EU_region = ifelse(nom_pays %in% eastern, "eastern",
                            ifelse(nom_pays %in% western, "western",
                                   ifelse(nom_pays %in% southern, "southern",
                                          "northern"))))
facet_EU <- IO_all2 %>% 
  filter(nom_pays != "Reste du monde") %>%
  group_by(nom_pays) %>%
  mutate(agg.demande_impact=sum(GES_impact_M_select),
         agg.producteur_impact=sum(GES_impact_S_select),
         agg.VA_impact=sum(impact_VA_select),
         agg.production=sum(production_pays),
         agg.demande_finale=sum(DF_tot)) %>%
  ungroup() %>%
  mutate(categorie.produit=substr(produits, 1,5)) %>% 
  pivot_longer(
    cols = c("agg.producteur_impact","agg.demande_impact","agg.VA_impact"),
    names_to = "indicator",
    values_to = "impact") %>%
  as.data.frame() %>% 
  ggplot( 
    aes(x= nom_pays, 
        y = impact,
        fill = indicator)) +
  geom_bar(stat='identity',position = "dodge", width=0.8) +
  theme(axis.text.x = element_text(angle = 25, size=10, vjust = 1, hjust=1),
        plot.title =element_text(size=12, face='bold', hjust=0.5),
        panel.background = element_blank(),
        panel.grid.major.y=element_line(color="gray",size=0.5,linetype = 2),
        plot.margin = unit(c(10,5,5,5), "mm"))+
  labs(title="Impacts",
       x ="Région ou pays", y = "Impact GES (CO2eq)",
       fill="Indicateur") +
  scale_fill_manual(
    labels = c("Demande", "Production","VA"), 
    values = c("indianred1", "cornflowerblue","orange1")) +
  facet_grid(~EU_region, scales="free_x")
facet_EU
```

On voit également des contrastes à l'échelle régionale. L'Europe de l'Ouest et du Sud ont le plus fort impact. Ces deux régions sont également très hétérogènes, au contraire de l'Europe de l'Est et du Sud dont les impacts sont plus homogènes entre pays.
Les pays d'Europe de l'Est sont généralement désavantagés par l'approche producteur (approche selon lauelle ils ont le plus fort impact) alors que les autres sont généralement désavantagés par l'approche valeur ajoutée. 

```{r parts impacts secteurs, echo=FALSE}
part_D = IO_all2 %>% 
  filter(nom_pays != "Reste du monde",
         produits != "SERVICES EXTRA-TERRITORIAUX") %>%
  pivot_longer(
    cols = c("GES_impact_M_select","GES_impact_S_select","impact_VA_select"),
    names_to = "cat",
    values_to = "val") %>%
  select(produits,cat,val) %>%
  group_by(produits,cat) %>%
  mutate(valeur=sum(val)) %>%
  select(-val) %>% distinct() %>% ungroup(cat) %>%
  mutate(val2 = valeur[cat == "GES_impact_M_select"]/sum(valeur)) %>%
  ungroup() %>%
  arrange(val2) %>%
  as.data.frame() %>% 
  ggplot( 
    aes(x= reorder(produits,val2), 
        y = valeur,
        fill = cat)) + #group=valeur
  geom_col(position = position_fill(reverse = TRUE)) +
  theme(axis.text.x = element_text(angle = 25, size=5, vjust = 1, hjust=1),
        plot.title =element_text(size=12, face='bold', hjust=0.5),
        panel.background = element_blank(),
        panel.grid.major.y=element_line(color="gray",size=0.5,linetype = 2),
        plot.margin = unit(c(10,5,5,5), "mm"))+
  labs(title=NULL,
       x =NULL, y = NULL,
       fill="Indicateur") +
  scale_fill_manual(
    labels = c("Demande", "Production","VA"), 
    values = c("indianred1", "cornflowerblue","orange1"))

part_P = IO_all2 %>% 
  filter(nom_pays != "Reste du monde",
         produits != "SERVICES EXTRA-TERRITORIAUX") %>%
  pivot_longer(
    cols = c("GES_impact_S_select","GES_impact_M_select","impact_VA_select"),
    names_to = "cat",
    values_to = "val") %>%
  select(produits,cat,val) %>%
  group_by(produits,cat) %>%
  mutate(valeur=sum(val)) %>%
  select(-val) %>% distinct() %>% ungroup(cat) %>%
  mutate(val2 = valeur[cat == "GES_impact_S_select"]/sum(valeur)) %>%
  ungroup() %>%
  arrange(val2) %>%
  as.data.frame() %>% 
  ggplot( 
    aes(x= reorder(produits,val2), 
        y = valeur,
        fill = factor(cat, levels=c("GES_impact_S_select","GES_impact_M_select","impact_VA_select")))) + #group=valeur
  geom_col(position = position_fill(reverse = TRUE)) +
  theme(axis.text.x = element_text(angle = 25, size=5, vjust = 1, hjust=1),
        plot.title =element_text(size=12, face='bold', hjust=0.5),
        panel.background = element_blank(),
        panel.grid.major.y=element_line(color="gray",size=0.5,linetype = 2),
        plot.margin = unit(c(10,5,5,5), "mm"))+
  labs(title=NULL,
       x =NULL, y = NULL,
       fill="Indicateur") +
  scale_fill_manual(
    labels = c("Production", "Demande","VA"), 
    values = c("cornflowerblue", "indianred1","orange1"))

part_VA = IO_all2 %>% 
  filter(nom_pays != "Reste du monde",
         produits != "SERVICES EXTRA-TERRITORIAUX") %>%
  pivot_longer(
    cols = c("GES_impact_M_select","GES_impact_S_select","impact_VA_select"),
    names_to = "cat",
    values_to = "val") %>%
  select(produits,cat,val) %>%
  group_by(produits,cat) %>%
  mutate(valeur=sum(val)) %>%
  select(-val) %>% distinct() %>% ungroup(cat) %>%
  mutate(val2 = valeur[cat == "impact_VA_select"]/sum(valeur)) %>%
  ungroup() %>%
  arrange(val2) %>%
  as.data.frame() %>% 
  ggplot( 
    aes(x= reorder(produits,val2), 
        y = valeur,
        fill = cat)) + #group=valeur
  geom_col(position = position_fill(reverse = FALSE)) +
  theme(axis.text.x = element_text(angle = 25, size=5, vjust = 1, hjust=1),
        plot.title =element_text(size=12, face='bold', hjust=0.5),
        panel.background = element_blank(),
        panel.grid.major.y=element_line(color="gray",size=0.5,linetype = 2),
        plot.margin = unit(c(10,5,5,5), "mm"))+
  labs(title=NULL,
       x =NULL, y = NULL,
       fill="Indicateur") +
  scale_fill_manual(
    labels = c("Demande", "Production","VA"), 
    values = c("indianred1", "cornflowerblue","orange1")) 

figure=ggarrange(part_D, part_P, part_VA,
          common.legend = TRUE, labels=NULL,
          ncol = 3, nrow = 1, heights = c(6, 6, 6))

figure=annotate_figure(figure,
                top = text_grob("Parts de chaque impact par secteur", face = "bold", size = 12),
                bottom = text_grob("Secteur"),
                left = text_grob("Parts (en %)", rot = 90))
figure
```


Le graphique ci-dessus montre à quel point chaque secteur peut-être avantagé ou désavantagé par l'approche choisie : il représente la part de chaque approche dans l'impact total d'un secteur.

En ce qui concerne la répartition des impacts selon l'approche adoptée, il semble y avoir une corrélation positive entre la part de l'impact de la demande et la part de l'impact créé par la valeur ajoutée. Il y a aussi une corrélation négative entre la part de ces deux impacts, et la part de l'impact producteur.


Deux secteurs ressortent particulièrement: "ELECTRICITE, GAZ ET EAU" et "PRODUITS D'EXTRACTION" ont à la fois le plus faible impact demande et revenu en proportion, et la plus forte part d'impact producteur.
Le secteur "ACTIVITES DES MENAGES" est le plus avantagé par l'approche producteur et le plus désavantagé par l'approche revenus.

```{r parts impacts pays, echo=FALSE}
part_D_pays = IO_all2 %>% 
  filter(nom_pays != "Reste du monde",
         produits != "SERVICES EXTRA-TERRITORIAUX") %>%
  pivot_longer(
    cols = c("GES_impact_M_select","GES_impact_S_select","impact_VA_select"),
    names_to = "cat",
    values_to = "val") %>%
  select(nom_pays,cat,val) %>%
  group_by(nom_pays,cat) %>%
  mutate(valeur=sum(val)) %>%
  select(-val) %>% distinct() %>% ungroup(cat) %>%
  mutate(val2 = valeur[cat == "GES_impact_M_select"]/sum(valeur)) %>%
  ungroup() %>%
  arrange(val2) %>%
  as.data.frame() %>% 
  ggplot( 
    aes(x= reorder(nom_pays,val2), 
        y = valeur,
        fill = cat)) + #group=valeur
  geom_col(position = position_fill(reverse = TRUE)) +
  theme(axis.text.x = element_text(angle = 25, size=3, vjust = 1, hjust=1),
        plot.title =element_text(size=12, face='bold', hjust=0.5),
        panel.background = element_blank(),
        panel.grid.major.y=element_line(color="gray",size=0.5,linetype = 2),
        plot.margin = unit(c(10,5,5,5), "mm"))+
  labs(title=NULL,
       x =NULL, y = NULL,
       fill="Indicateur") +
  scale_fill_manual(
    labels = c("Demande", "Production","VA"), 
    values = c("indianred1", "cornflowerblue","orange1")) 

part_P_pays = IO_all2 %>% 
  filter(nom_pays != "Reste du monde",
         produits != "SERVICES EXTRA-TERRITORIAUX") %>%
  pivot_longer(
    cols = c("GES_impact_S_select","GES_impact_M_select","impact_VA_select"),
    names_to = "cat",
    values_to = "val") %>%
  select(nom_pays,cat,val) %>%
  group_by(nom_pays,cat) %>%
  mutate(valeur=sum(val)) %>%
  select(-val) %>% distinct() %>% ungroup(cat) %>%
  mutate(val2 = valeur[cat == "GES_impact_S_select"]/sum(valeur)) %>%
  ungroup() %>%
  arrange(val2) %>%
  as.data.frame() %>% 
  ggplot( 
    aes(x= reorder(nom_pays,val2), 
        y = valeur,
        fill = factor(cat, levels=c("GES_impact_S_select","GES_impact_M_select","impact_VA_select")))) + #group=valeur
  geom_col(position = position_fill(reverse = TRUE)) +
  theme(axis.text.x = element_text(angle = 25, size=3, vjust = 1, hjust=1),
        plot.title =element_text(size=12, face='bold', hjust=0.5),
        panel.background = element_blank(),
        panel.grid.major.y=element_line(color="gray",size=0.5,linetype = 2),
        plot.margin = unit(c(10,5,5,5), "mm"))+
  labs(title=NULL,
       x =NULL, y = NULL,
       fill="Indicateur") +
  scale_fill_manual(
    labels = c("Production", "Demande","VA"), 
    values = c("cornflowerblue", "indianred1","orange1"))

part_VA_pays = IO_all2 %>% 
  filter(nom_pays != "Reste du monde",
         produits != "SERVICES EXTRA-TERRITORIAUX") %>%
  pivot_longer(
    cols = c("GES_impact_M_select","GES_impact_S_select","impact_VA_select"),
    names_to = "cat",
    values_to = "val") %>%
  select(nom_pays,cat,val) %>%
  group_by(nom_pays,cat) %>%
  mutate(valeur=sum(val)) %>%
  select(-val) %>% distinct() %>% ungroup(cat) %>%
  mutate(val2 = valeur[cat == "impact_VA_select"]/sum(valeur)) %>%
  ungroup() %>%
  arrange(val2) %>%
  as.data.frame() %>% 
  ggplot( 
    aes(x= reorder(nom_pays,val2), 
        y = valeur,
        fill = cat)) + #group=valeur
  geom_col(position = position_fill(reverse = FALSE)) +
  theme(axis.text.x = element_text(angle = 25, size=3, vjust = 1, hjust=1),
        plot.title =element_text(size=12, face='bold', hjust=0.5),
        panel.background = element_blank(),
        panel.grid.major.y=element_line(color="gray",size=0.5,linetype = 2),
        plot.margin = unit(c(10,5,5,5), "mm"))+
  labs(title=NULL,
       x =NULL, y = NULL,
       fill="Indicateur") +
  scale_fill_manual(
    labels = c("Demande", "Production","VA"), 
    values = c("indianred1", "cornflowerblue","orange1")) 

figure_pays=ggarrange(part_D_pays, part_P_pays, part_VA_pays,
          common.legend = TRUE, labels=NULL,
          ncol = 1, nrow = 3)

figure_pays=annotate_figure(figure_pays,
                top = text_grob("Parts de chaque impact par pays", face = "bold", size = 12),
                bottom = text_grob("Pays"),
                left = text_grob("Parts (en %)", rot = 90))
figure_pays
```

Le graphique ci-dessus permet de tirer le même type de conclusions mais au niveau des pays, et non des secteurs.

Le constat n'est pas le même: il semble plutôt y avoir une corrélation positive entre le fait d'être avantagé par l'approche demande et le fait d'être avantagé par l'approche production ; et une corrélation négative avec le fait d'être avantagé par l'approche revenus. 


La conclusion est donc que selon qu'on adopte une approche territoriale/nationale ou une approche sectorielle, la répartition des coûts suit une logique différente.