---
title: "Rapport résultats EU : indicateurs de comptabilité carbone"
author: "Léa Settepani"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(data.table)
library(readxl)
library(openxlsx)
library(stringr)
library(ggpubr)
library(ggradar)
```


intro meta sur la question de la resp, contextualiser
rappel des concepts et la problématique

## Revue
principales études

## Description des données utilisées

```{r paths generaux, include=FALSE}
year = 2015

#Chemin user, du projet, et données résultats
path_user <- str_c("C:/Users/leasy/")
path_codedata <- str_c(path_user,"Documents/GitHub/EmissionsIndicators/")

path_data.source <- str_c(path_user,"Documents/GitHub/EmissionsIndicators/data_in/")
```

### Données

Données exiobase pour le modèle input-output.



Données économiques et démographiques Eurostat pour ajuster les graphiques.

```{r données eurostat, include=FALSE}
pib=read_xlsx(str_c(path_data.source,"eurostat/PIBhab.xlsx"),
          sheet="Feuille 1",
          skip=8,
          col_names = TRUE)
pib=pib[-c(1,41:49),c("TIME",year)]
pib=setnames(pib,old=c("TIME",year),new=c("nom_pays","PIB.hab"))
pib[pib$nom_pays=="Allemagne (jusqu'en 1990, ancien territoire de la RFA)",]$nom_pays = "Allemagne"
pib[pib$nom_pays=="Tchéquie",]$nom_pays = "République Tchèque"

pop=read_xlsx(str_c(path_data.source,"eurostat/population.xlsx"),
              sheet="Feuille 1",
              skip=6,
              col_names = TRUE)
pop=pop[-c(1,56:66),c("TIME",year)]
pop=setnames(pop,old=c("TIME",year),new=c("nom_pays","population"))
pop$population = as.numeric(pop$population)
pop[pop$nom_pays=="Allemagne (jusqu'en 1990, ancien territoire de la RFA)",]$nom_pays = "Allemagne"
pop[pop$nom_pays=="Tchéquie",]$nom_pays = "République Tchèque"
```

### Démarche et indicateurs



## Visualisation et analyse des résultats

### échelle monde pour le cadre

```{r nomenclatures et header monde, echo=FALSE}
year <- 2015
br <- "CPA2002_Niv1"
br_pays <- "monde.12"

path_results_tables <- str_c(path_codedata, "results/IO_pays/", year,"/",br_pays,"_",br,"/")

table_monde <- readRDS(str_c(path_results_tables, "IO_all_",br_pays,"_",br,".rds"))
```

```{r monde datawork, include=FALSE}
monde_secteurs <- table_monde %>% 
  group_by(produits) %>%
  filter(produits != "SERVICES EXTRA-TERRITORIAUX") %>%
  mutate(agg.demande_impact=sum(GES_impact_M_select),
         agg.producteur_impact=sum(GES_impact_S_select),
         agg.VA_impact=sum(impact_VA_select),
         agg.production=sum(production_pays),
         agg.demande_finale=sum(DF_tot)) %>%
  ungroup() %>% 
  pivot_longer(
    cols = c("agg.producteur_impact","agg.demande_impact","agg.VA_impact"),
    names_to = "indicator",
    values_to = "impact") %>%
  as.data.frame() %>% 
  ggplot( 
    aes(x= produits, 
        y = impact/10^12,
        fill = indicator)) +
  geom_bar(stat='identity',position = "dodge") +
  theme(axis.text.x = element_text(angle = 25, size=4, vjust = 1, hjust=1),
        plot.title =element_text(size=12, face='bold', hjust=0.5),
        panel.background = element_blank(),
        panel.grid.major.y=element_line(color="gray",size=0.5,linetype = 2),
        plot.margin = unit(c(10,5,5,5), "mm"))+
  labs(title="Impacts",
       x ="Secteurs", y = "Impact GES (Gt CO2eq)",
       fill="Indicateur") +
  scale_fill_manual(labels = c("Demande", "Production","VA"), values = c("indianred1", "cornflowerblue","orange1"))
```

```{r monde secteurs, echo=FALSE}
monde_secteurs
```

#### europe

```{r nomenclatures et header EU, echo=FALSE}
year <- 2015
br <- "CPA2002_Niv1"
br_pays <- "EU1"


path_results_tables <- str_c(path_codedata, "results/IO_pays/", year,"/",br_pays,"_",br,"/")

table_EU <- readRDS(str_c(path_results_tables, "IO_all_",br_pays,"_",br,".rds"))
```
SECTEURS EUROPE SEULEMENT SI GROSSE DIFF

```{r calculs intro}
table_EU %>% 
  mutate(binaire = ifelse(nom_pays == "Reste du monde",
                          "Reste",
                          "EU")) %>% 
  group_by(binaire) %>%
  mutate(agg.demande_impact=sum(GES_impact_M_select),
         agg.producteur_impact=sum(GES_impact_S_select),
         agg.VA_impact=sum(impact_VA_select)) %>%
  ungroup() %>%
  select(binaire,agg.demande_impact,agg.producteur_impact,agg.VA_impact) %>%
  distinct()
```

Avant de détailler comment se répartissent les impacts environnementaux au sein de l'Union Européenne, on situe celle-ci par rapport au reste du monde.

L'impact en gaz à effets de serre de l'Union Européenne est bien moindre que celui du reste du monde (RDM), quel que soit l'indicateur choisi. L'impact de la demande du RDM est 7 fois plus élevé que celui de la demande européenne, l'impact de la production du RDM est 9 fois plus élevé que celui de la production européenne, l'impact des revenus du RDM est plus de 3 fois supérieur à celui des revenus européens.

```{r results, include=FALSE}
for (pays in c("Autriche","Belgique","Bulgarie","Chypre","République Tchèque","Allemagne",
               "Danemark","Estonie","Espagne","Finlande","France","Grèce","Croatie","Hongrie",
               "Irlande","Italie","Lituanie","Luxembourg","Lettonnie","Malte","Pays-bas",
               "Pologne","Portugal","Roumanie","Suède","Slovénie","Slovaquie","Royaume-Uni",
               "Reste du monde")) {

  IO <- readRDS(str_c(path_results_tables,"IO_",pays,".rds"))
  assign(str_c("IO_",pays),IO)
  rm(IO)
}

#Créer grand dataframe (monde)
IO_all <- do.call("rbind",mget(ls(pattern = "^IO_*")))

#Ajouter données eurostat
IO_all_ponderation=merge(IO_all,pib,by.x="nom_pays")
IO_all_ponderation=merge(IO_all_ponderation,pop,by.x="nom_pays")

#Plot monde secteurs
EU_secteurs <- table_EU %>% 
  group_by(produits) %>%
  filter(produits != "SERVICES EXTRA-TERRITORIAUX",
         nom_pays != "Reste du monde") %>%
  mutate(agg.demande_impact=sum(GES_impact_M_select),
         agg.producteur_impact=sum(GES_impact_S_select),
         agg.VA_impact=sum(impact_VA_select),
         agg.production=sum(production_pays),
         agg.demande_finale=sum(DF_tot)) %>%
  ungroup() %>% 
  pivot_longer(
    cols = c("agg.producteur_impact","agg.demande_impact","agg.VA_impact"),
    names_to = "indicator",
    values_to = "impact") %>%
  as.data.frame() %>% 
  ggplot( 
    aes(x= produits, 
        y = impact/10^12,
        fill = indicator)) +
  geom_bar(stat='identity',position = "dodge") +
  theme(axis.text.x = element_text(angle = 25, size=4, vjust = 1, hjust=1),
        plot.title =element_text(size=12, face='bold', hjust=0.5),
        panel.background = element_blank(),
        panel.grid.major.y=element_line(color="gray",size=0.5,linetype = 2),
        plot.margin = unit(c(10,5,5,5), "mm"))+
  labs(title="Impacts",
       x ="Secteurs", y = "Impact GES (Gt CO2eq)",
       fill="Indicateur") +
  scale_fill_manual(labels = c("Demande", "Production","VA"), values = c("indianred1", "cornflowerblue","orange1"))

#Plot européen par pays
EU_pays <- IO_all %>% 
  filter(nom_pays != "Reste du monde") %>%
  group_by(nom_pays) %>%
  mutate(agg.demande_impact=sum(GES_impact_M_select),
         agg.producteur_impact=sum(GES_impact_S_select),
         agg.VA_impact=sum(impact_VA_select),
         agg.production=sum(production_pays),
         agg.demande_finale=sum(DF_tot)) %>%
  ungroup() %>%
  pivot_longer(
    cols = c("agg.producteur_impact","agg.demande_impact","agg.VA_impact"),
    names_to = "indicator",
    values_to = "impact") %>%
  as.data.frame() %>% 
  ggplot( 
    aes(x= nom_pays, 
        y = impact/10^12, #/10^12 convertit en gt
        fill = indicator)) +
  geom_bar(stat='identity',position = "dodge") +
  theme(axis.text.x = element_text(angle = 25, size=6, vjust = 1, hjust=1),
        plot.title =element_text(size=12, face='bold', hjust=0.5),
        panel.background = element_blank(),
        panel.grid.major.y=element_line(color="gray",size=0.5,linetype = 2),
        plot.margin = unit(c(10,5,5,5), "mm"))+
  labs(title="Impacts",
       x ="Région ou pays", y = "Impact GES (Gt CO2eq)",
       fill="Indicateur") +
  scale_fill_manual(labels = c("Demande", "Production","VA"), values = c("indianred1", "cornflowerblue","orange1"))

#Plot européen par secteur pour VA
EU_secteurs_VA=IO_all %>% 
  filter(nom_pays != "Reste du monde") %>%
  #par produits
  group_by(produits) %>%
  filter(produits != "SERVICES EXTRA-TERRITORIAUX") %>% #toujours=0
  mutate(agg.Etat=sum(Etat),
         agg.Travail=sum(Travail),
         agg.Capital=sum(Capital),
         agg.Cout=sum(Cout_production)) %>%
  ungroup() %>%
  #format long pour afficher les deux indicateurs
  pivot_longer(
    cols = c("agg.Etat","agg.Travail","agg.Capital","agg.Cout"),
    names_to = "composante",
    values_to = "impact") %>%
  ggplot( 
    aes(x= produits, 
        y = impact/10^12,
        fill = composante)) +
  geom_bar(stat='identity',
           position = position_stack(reverse = FALSE)) + #fill
  theme(axis.text.x = element_text(angle = 25, size=4, vjust = 1, hjust=1),
        plot.title =element_text(size=12, face='bold', hjust=0.5),
        panel.background = element_blank(),
        panel.grid.major.y=element_line(color="gray",size=0.5,linetype = 2),
        plot.margin = unit(c(10,5,5,5), "mm"))+
  labs(title="Impacts",
       x ="Secteurs", y = "Impact GES (Gt CO2eq)",
       fill="Rémunération de:") +
  scale_fill_manual(labels = c("Taxes", "Travail","Capital (net)","Capital (dépréciation)"), values = c("yellow", "tomato","slateblue1","slateblue"))

EU_secteurs_VA_norm <- table_EU %>% 
  filter(nom_pays != "Reste du monde") %>%
  #par produits
  group_by(produits) %>%
  filter(produits != "SERVICES EXTRA-TERRITORIAUX") %>% #toujours=0
  mutate(agg.Etat=sum(Etat),
         agg.Travail=sum(Travail),
         agg.Capital=sum(Capital),
         agg.Cout=sum(Cout_production)) %>%
  ungroup() %>%
  #format long pour afficher les deux indicateurs
  pivot_longer(
    cols = c("agg.Etat","agg.Travail","agg.Capital","agg.Cout"),
    names_to = "composante",
    values_to = "impact") %>%
  ggplot( 
    aes(x= produits, 
        y = impact,
        fill = composante,
        alpha=0.9)) +
  guides(alpha="none") +
  geom_col(position = position_fill(reverse = FALSE)) + #fill
  theme(axis.text.x = element_text(angle = 25, size=4, vjust = 1, hjust=1),
        plot.title =element_text(size=12, face='bold', hjust=0.5),
        panel.background = element_blank(),
        panel.grid.major.y=element_line(color="gray",size=0.5,linetype = 2),
        plot.margin = unit(c(10,5,5,5), "mm"))+
  labs(title="Impacts",
       x ="Secteurs", y = "Part des composantes (%)",
       fill="Rémunération de:") +
  scale_fill_manual(labels = c("Taxes", "Travail","Capital (net)","Capital (dépréciation)"), values = c("yellow", "tomato","slateblue1","slateblue"))

EU_groupes_pays <- IO_all_ponderation %>%
  mutate(level_income = ifelse(PIB.hab < 20000, "<20,000€",
                            ifelse(PIB.hab >= 20000 & PIB.hab <= 35000, "20,000-35,000 €",
                                   ">35,000 €"))) %>% 
  #filter(nom_pays != "Reste du monde") %>%
  group_by(nom_pays) %>%
  mutate(agg.demande_impact=sum(GES_impact_M_select),
         agg.producteur_impact=sum(GES_impact_S_select),
         agg.VA_impact=sum(impact_VA_select),
         agg.production=sum(production_pays),
         agg.demande_finale=sum(DF_tot)) %>%
  ungroup() %>%
  pivot_longer(
    cols = c("agg.producteur_impact","agg.demande_impact","agg.VA_impact"),
    names_to = "indicator",
    values_to = "impact") %>%
  as.data.frame() %>% 
  ggplot( 
    aes(x= nom_pays, 
        y = impact/10^12,
        fill = indicator)) +
  geom_bar(stat='identity',position = "dodge") +
  theme(axis.text.x = element_text(angle = 25, size=10, vjust = 1, hjust=1),
        plot.title =element_text(size=12, face='bold', hjust=0.5),
        panel.background = element_blank(),
        panel.grid.major.y=element_line(color="gray",size=0.5,linetype = 2),
        plot.margin = unit(c(10,5,5,5), "mm"))+
  labs(title="Impacts",
       x ="Région ou pays", y = "Impact GES (Gt CO2eq)",
       fill="Indicateur") +
  scale_fill_manual(
    labels = c("Demande", "Production","VA"), 
    values = c("indianred1", "cornflowerblue","orange1")) +
  facet_grid(~level_income, scales="free_x")

EU_pays_pondere=IO_all_ponderation %>% 
  #filter(nom_pays != "Reste du monde") %>%
  group_by(nom_pays) %>%
  mutate(agg.demande_impact=sum(GES_impact_M_select),
         agg.producteur_impact=sum(GES_impact_S_select),
         agg.VA_impact=sum(impact_VA_select),
         agg.production=sum(production_pays),
         agg.demande_finale=sum(DF_tot),
         agg.VA=sum(VA_pays)) %>%
  ungroup() %>%
  mutate(categorie.produit=substr(produits, 1,5)) %>% 
  pivot_longer(
    cols = c("agg.producteur_impact","agg.demande_impact","agg.VA_impact"),
    names_to = "indicator",
    values_to = "impact") %>%
  mutate(norm=(impact/population)/1000) %>%
  as.data.frame() %>% 
  ggplot( 
    aes(x= nom_pays, 
        y = norm,
        fill = indicator)) +
  geom_bar(stat='identity',position = "dodge") +
  theme(axis.text.x = element_text(angle = 25, size=10, vjust = 1, hjust=1),
        plot.title =element_text(size=12, face='bold', hjust=0.5),
        panel.background = element_blank(),
        panel.grid.major.y=element_line(color="gray",size=0.5,linetype = 2),
        plot.margin = unit(c(10,5,5,5), "mm"))+
  labs(title="Impacts",
       x ="Région ou pays", y = "Impact GES (tCO2eq/cap)",
       fill="Indicateur") +
  scale_fill_manual(labels = c("Demande", "Production","VA"), 
                    values = c("indianred1", "cornflowerblue","orange1"))
```



### Faits stylisés au niveau européen

Les trois graphiques au niveau européen sont inclus pour avoir une vision plus globale.

```{r monde pays, echo=FALSE, fig.cap="D'importantes disparités dans les impacts des pays de l'UE"}

ggarrange(EU_pays, EU_pays_pondere,
          common.legend = TRUE, labels=NULL,
          ncol = 1, nrow = 2)
```

Dans l'Union Européenne, la plupart des pays sont nets demandeurs d'émissions. L'Union dans son ensemble est également nette demandeuse d'émissions (le reste du monde produit plus d'émissions qu'il n'en demande). Certains pays européens sont nets producteurs (la Bulgarie, Chypre, l'Estonie, la Grèce, la Pologne, le Portugal, la République Tchèque) mais la différence n'est flagrante que pour quatre d'entre eux.

L'Allemagne a de loin le plus fort impact selon les trois approches. 

Les petits pays et certains pays d'Europe du Nord ont le plus faible impact (Chypre, Malte, le Luxembourg, la Croatie, l'Estonie, la Lettonie, la Lituanie).



```{r EU secteurs, echo=FALSE}
EU_secteurs
```

Dans une approche sectorielle, le plus fort contraste entre secteurs s'observe au niveau de l'impact producteur. Le secteur "ELECTRICITE, GAZ ET EAU" se détache nettement avec le plus fort impact producteur, suivi par les "PRODUITS MANUFACTURES".

Le plus fort impact demande concerne les secteurs "PRODUITS MANUFACTURES", "SERVICES IMMOBILIERS, DE LOCATION ET AUX ENTREPRISES" et "TRAVAUX DE CONSTRUCTION".

Enfin, les secteurs des "SERVICES IMMOBILIERS, DE LOCATION ET AUX ENTREPRISES" et des "PRODUITS MANUFACTURES" ont le plus fort impact revenus.

```{r monde secteurs va, echo=FALSE, warning=FALSE, dev="png", dpi=400}
EU_secteurs_VA

EU_secteurs_VA_norm
```

Globalement, parmi les facteurs de production c'est le capital fixe qui a le plus fort impact. L'impacts du capital est le plus petit en proportion pour chaque secteur. 

### Contrastes par pays

```{r groupes pays eu, echo=FALSE}
EU_groupes_pays
```

On voit également des contrastes à l'échelle régionale. L'Europe de l'Ouest et du Sud ont le plus fort impact. Ces deux régions sont également très hétérogènes, au contraire de l'Europe de l'Est et du Sud dont les impacts sont plus homogènes entre pays.
Les pays d'Europe de l'Est sont généralement désavantagés par l'approche producteur (approche selon lauelle ils ont le plus fort impact) alors que les autres sont généralement désavantagés par l'approche valeur ajoutée. 

```{r parts impacts secteurs, echo=FALSE}
 #figure
```

EX FIGURE
Le graphique ci-dessus montre à quel point chaque secteur peut-être avantagé ou désavantagé par l'approche choisie : il représente la part de chaque approche dans l'impact total d'un secteur.

En ce qui concerne la répartition des impacts selon l'approche adoptée, il semble y avoir une corrélation positive entre la part de l'impact de la demande et la part de l'impact créé par la valeur ajoutée. Il y a aussi une corrélation négative entre la part de ces deux impacts, et la part de l'impact producteur.


Deux secteurs ressortent particulièrement: "ELECTRICITE, GAZ ET EAU" et "PRODUITS D'EXTRACTION" ont à la fois le plus faible impact demande et revenu en proportion, et la plus forte part d'impact producteur.
Le secteur "ACTIVITES DES MENAGES" est le plus avantagé par l'approche producteur et le plus désavantagé par l'approche revenus.

```{r parts impacts pays, echo=FALSE}
#figure_pays
radar_data3 = IO_all_ponderation %>% 
  filter(nom_pays != "Reste du monde") %>%
  group_by(nom_pays) %>%
  mutate(agg.demande_impact=sum(GES_impact_M_select/population)/1000,
         agg.producteur_impact=sum(GES_impact_S_select/population)/1000,
         agg.VA_impact=sum(impact_VA_select/population)/1000) %>%
  ungroup() %>%
  distinct(nom_pays,agg.demande_impact,agg.producteur_impact,agg.VA_impact) 
radar_data3.pays=radar_data3$nom_pays
radar_data3=radar_data3%>%select(-nom_pays) %>%  t() %>% 
  as.data.frame() %>%
  `colnames<-`(radar_data3.pays) %>%
  add_rownames( var = "group" ) 

ggradar(radar_data3,
        axis.label.size = 2,
        axis.label.offset = 1.1,
        grid.min = 0,
        grid.max = max(radar_data3[,-1]),
        grid.line.width=0.1,
        label.gridline.min = FALSE,
        gridline.min.colour="gray",
        gridline.min.linetype="longdash",
        label.gridline.mid = FALSE,
        gridline.mid.colour="gray",
        gridline.mid.linetype="longdash",
        label.gridline.max = FALSE,
        gridline.max.colour="gray",
        gridline.max.linetype="longdash",
        group.line.width = 0.5,
        group.point.size = 1,
        background.circle.transparency=0,
        legend.title = "Indicateur",
        legend.text.size = 10,
        fill=TRUE,
        fill.alpha = 0.25)+
  theme(legend.title = element_text(size=12)) +
  scale_fill_manual(labels = c("Demande", "Production","VA"), #
                    values = c("indianred1", "cornflowerblue","orange1")) +
  scale_colour_manual(labels = c("Demande", "Production","VA"), #
                      values = c("indianred1", "cornflowerblue","orange1")) +
  guides(fill="none")
```

EX FIGURE_PAYS
Le graphique ci-dessus permet de tirer le même type de conclusions mais au niveau des pays, et non des secteurs.

Le constat n'est pas le même: il semble plutôt y avoir une corrélation positive entre le fait d'être avantagé par l'approche demande et le fait d'être avantagé par l'approche production ; et une corrélation négative entre le fait d'être avantagé par ces deux approches et par l'approche revenus. L'exemple typique est la Suède : c'est à la fois le pays qui est le plus avantagé par les indicateurs demande et producteur, et celui qui est le plus désavantagé par l'indicateur valuer ajoutée (son impact est 5 fois plus grand selon l'indicateur valeur ajoutée que selon l'indicateur production).

L'hétérogénéité semble moins forte que dans l'approche sectorielle. L'approche par la demande semble traiter les pays européens de la façon la plus égalitaire (sans tenir compte ici du niveau de richesse, de la taille du pays). L'approche valeur ajoutée est celle qui présente le plus de disparités entre pays.


La conclusion est donc que selon qu'on adopte une approche territoriale/nationale ou une approche sectorielle, la répartition des coûts suit une logique différente.

## Conclusion

CHANGER UNITES DES GRAPHS (V)

NORMALISER PAR POPULATION (V)

PAR UNITE PRODUITE (V)

EDIT GRAPH VA (AUSSI AJOUTER GRAPH NORMALISE PAR EURO DE VA) (V)

AJOUTER UN RADAR PAR PAYS OU CHAQUE AXE EST UN SECTEUR (PE CHOISIR QQUES PAYS POUR LE DOC) (V)

GROUPES DE PIB PAR HABITANT AU LIEU DE REGIONS, TROIS OU QUATRE CATEGORIES  (V)